<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfinityShare - Send</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f7f6; }
        .card { background: white; max-width: 400px; margin: 0 auto; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Button Styles */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 14px; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-upload { background: #4a90e2; width: 100%; justify-content: center; }
        .btn-save { background: #333; }
        .btn-share { background: #2ecc71; }
        
        input[type="file"] { margin: 20px 0; }
        
        #linkBox { background: #eef; padding: 10px; word-break: break-all; margin-top: 15px; display: none; border-radius: 5px; font-size: 12px; color: #555; }
        
        #qrcode { display: flex; justify-content: center; margin-top: 20px; }
        
        /* Control buttons container (Hidden by default) */
        #qrControls { display: none; margin-top: 15px; gap: 10px; justify-content: center; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üöÄ InfinityShare</h2>
        <p>Select a file to generate a QR code.</p>
        
        <input type="file" id="fileInput">
        
        <div id="status" style="color: orange; font-weight: bold;">Connecting...</div>
        
        <div id="qrcode"></div>

        <div id="qrControls">
            <button onclick="downloadQR()" class="btn btn-save">‚¨áÔ∏è Save</button>
            <button onclick="shareQR()" class="btn btn-share">üì§ Share</button>
        </div>

        <div id="linkBox"></div>
        
        <div style="margin-top:20px; font-size:11px; color:#aaa; border-top:1px solid #eee; padding-top:10px;">
            <p>Your Ad Here</p>
        </div>
    </div>

    <a href="https://www.buymeacoffee.com/manishkumar14" target="_blank" style="position: fixed; bottom: 20px; right: 20px; background: #FFDD00; color: #000; padding: 12px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;">
        ‚òï Donate
    </a>

    <script>
        const peer = new Peer();
        let conn = null;

        peer.on('open', (id) => {
            document.getElementById('status').innerText = "Ready! Select a file.";
            document.getElementById('status').style.color = "green";

            document.getElementById('fileInput').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // 1. Get current URL automatically
                let currentUrl = window.location.href;
                let cleanUrl = currentUrl.replace('index.html', '').replace(/\/$/, "");
                const link = `${cleanUrl}/receiver.html?id=${id}&name=${encodeURIComponent(file.name)}&size=${file.size}`;

                // 2. Show Link Box
                document.getElementById('linkBox').style.display = 'block';
                document.getElementById('linkBox').innerText = link;
                
                // 3. Generate QR Code
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = ""; // Clear old QR
                new QRCode(qrContainer, { text: link, width: 180, height: 180 });
                
                // 4. Show Save/Share buttons
                document.getElementById('qrControls').style.display = 'flex';
                document.getElementById('status').innerText = "File Ready! Scan or Share.";
            });
        });

        // --- NEW FUNCTIONS FOR BUTTONS ---

        function downloadQR() {
            // Find the canvas image created by the QR library
            const canvas = document.querySelector('#qrcode canvas');
            if(canvas) {
                // Convert to image URL
                const image = canvas.toDataURL("image/png");
                // Create a fake link to trigger download
                const link = document.createElement('a');
                link.href = image;
                link.download = 'infinity-share-qr.png';
                link.click();
            } else {
                alert("Please select a file first!");
            }
        }

        function shareQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                // Convert canvas to a 'Blob' (file-like object)
                canvas.toBlob(function(blob) {
                    const file = new File([blob], "qr-code.png", { type: "image/png" });
                    
                    // Use the native sharing API (Works on Mobile)
                    if (navigator.share) {
                        navigator.share({
                            title: 'Download File',
                            text: 'Scan this QR to download the file!',
                            files: [file]
                        }).catch(console.error);
                    } else {
                        alert("Your browser does not support direct sharing. Use the 'Save' button instead.");
                    }
                });
            }
        }

        // --- END NEW FUNCTIONS ---

        peer.on('connection', (connection) => {
            conn = connection;
            conn.on('open', () => {
                const file = document.getElementById('fileInput').files[0];
                const reader = new FileReader();
                conn.send({ type: 'meta', name: file.name, size: file.size, filetype: file.type });
                reader.onload = (e) => conn.send({ type: 'chunk', data: e.target.result });
                reader.readAsArrayBuffer(file); 
                document.getElementById('status').innerText = "Sending... DO NOT CLOSE!";
                document.getElementById('status').style.color = "red";
            });
        });
    </script>
</body>
</html>

